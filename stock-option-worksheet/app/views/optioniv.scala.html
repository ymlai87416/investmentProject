@import model.Database.Stock
@import model.Database.StockOption
@import model.Database.IVSeriesTimePoint
@import org.joda.time.DateTime
@import java.util.Locale

@(stock: Stock, date: DateTime, minIV: Float, maxIV: Float, meanIV: Float, stdIV: Float, currentIV: Float, timePoints: List[IVSeriesTimePoint])

@stockCodeSelect(selectedStock: Stock) = {
    <select name="asset" class="form-control" id="assetViewBy">
    @for(p <- StockOption.underlyingStock){
        @if(selectedStock.sehkCode.map(p.sehkCode==).getOrElse(false)) {
            <option selected value="@p.sehkCode">@p.sehkCode - @p.name</option>
        } else {
            <option value="@p.sehkCode">@p.sehkCode - @p.name</option>
        }
    }
    </select>
}

@main("Super rich fund stock option IV worksheet"){

    <div class="container">
        <div class="row">
            <h2>@stock.name @date.toString("yyyy-MM-dd", Locale.US)</h2>
        </div>
        <div class="row">
            <form class="form-inline" action="javascript:void(0)">
                @stockCodeSelect(stock)

                <div class="form-group">
                    <div class='input-group date' id='datetimepicker1'>
                        <input type='text' class="form-control" id="dateTimePicker" name="date"/>
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                    </div>
                </div>
                <script type="text/javascript">
                        $(function () {
                            $('#datetimepicker1').datetimepicker({
                                defaultDate: "@date.toString("MM/dd/yyyy", Locale.US)"
                            });
                        });
                </script>

                <input type="button" class="btn btn-primary" onclick="redirectPage();" value="Submit" />
            </form>
        </div>

        <table class="table">
            <tr style="background-color:powderblue"><th colspan="2">Latest</th></tr>
            <tr>
                <td>Current IV</td>
                <td>@currentIV</td>
            </tr>
            <tr style="background-color:powderblue"><th colspan="2">History</th></tr>
            <tr><td>Maximum IV</td><td>@maxIV</td></tr>
            <tr><td>Minimum IV</td><td>@minIV</td></tr>
            <tr><td>Average IV</td><td>@meanIV</td></tr>
            <tr><td>Standard deviation</td><td>@stdIV</td></tr>
        </table>
    </div>

        <!--<div id="stockIVDiv" class="center-block" style="width:600px;height:480px"> here we draw the stock iv chart </div>-->

    <script>

        (function() {
            var d3 = Plotly.d3;

            var WIDTH_IN_PERCENT_OF_PARENT = 60,
                    HEIGHT_IN_PERCENT_OF_PARENT = 80;

            var gd3 = d3.select('body')
                    .append('div')
                    .style({
                        width: WIDTH_IN_PERCENT_OF_PARENT + '%',
                        'margin-left': (100 - WIDTH_IN_PERCENT_OF_PARENT) / 2 + '%',

                        height: 480
                    });

            var gd = gd3.node();

            Plotly.plot(gd, [{
                type: 'scatter',
                x: [@Html(timePoints.map(x => ("'" + x.date.toString("yyyy-MM-dd", Locale.US)) + " 00:00:00'").mkString(","))],
                y: [@timePoints.map(x => x.value).mkString(",")]
            }], {
                title: 'Implied volatility',
                font: {
                    size: 16
                }
            });

            window.onresize = function() {
                Plotly.Plots.resize(gd);
            };

        })();

        function redirectPage(){
            var date =document.getElementById("dateTimePicker").value;

            var assetCtrl = document.getElementById("assetViewBy");
            var asset = assetCtrl.options[assetCtrl.selectedIndex].value;

            var url="@routes.Application.ivDetail(0, date.toString("yyyy-MM-dd", Locale.US))".replace("0", asset);
            try{
                var date2 = moment(date, "MM/DD/YYYY HH:mm A").format("YYYY-MM-DD")
                url=url.replace("@date.toString("yyyy-MM-dd", Locale.US)", date2);
            }
            catch(err) { }

            window.location.href=url

        }
    </script>
}